name: Test S-Cape Travel Application

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PHP_VERSION: '8.2'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ›’ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, json, zip, curl
        
    - name: ðŸ“¦ Install Composer dependencies
      run: composer install --prefer-dist --no-progress
      
    - name: ðŸ” Validate composer.json
      run: composer validate --strict
      
    - name: ðŸ§ª PHP Syntax Check
      run: find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \;
      
    - name: ðŸ”§ Check critical files exist
      run: |
        echo "Checking critical application files..."
        
        # Core application files
        test -f index.php || (echo "âŒ Missing index.php" && exit 1)
        test -f callback.php || (echo "âŒ Missing callback.php" && exit 1)
        test -f dashboard.php || (echo "âŒ Missing dashboard.php" && exit 1)
        
        # Library files
        test -f lib/config_helper.php || (echo "âŒ Missing lib/config_helper.php" && exit 1)
        test -f lib/oidc_simple.php || (echo "âŒ Missing lib/oidc_simple.php" && exit 1)
        test -f lib/logger.php || (echo "âŒ Missing lib/logger.php" && exit 1)
        test -f lib/email_helper.php || (echo "âŒ Missing lib/email_helper.php" && exit 1)
        
        # Configuration files
        test -f .env.template || (echo "âŒ Missing .env.template" && exit 1)
        test -f composer.json || (echo "âŒ Missing composer.json" && exit 1)
        
        # Admin files
        test -f admin/cross_tenant_check.php || (echo "âŒ Missing admin/cross_tenant_check.php" && exit 1)
        
        echo "âœ… All critical files present"
        
    - name: ðŸ§© Test configuration loading
      run: |
        php -r "
        require_once 'vendor/autoload.php';
        
        // Test if configuration helper loads without errors
        if (file_exists('lib/config_helper.php')) {
            require_once 'lib/config_helper.php';
            echo 'âœ… Config helper loads successfully\n';
        } else {
            echo 'âŒ Config helper not found\n';
            exit(1);
        }
        
        // Test logger
        if (file_exists('lib/logger.php')) {
            require_once 'lib/logger.php';
            echo 'âœ… Logger loads successfully\n';
        } else {
            echo 'âŒ Logger not found\n';
            exit(1);
        }
        
        echo 'âœ… Basic application structure test passed\n';
        "
        
    - name: ðŸ“Š Generate test report
      run: |
        echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… PHP Syntax: Valid" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Dependencies: Installed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… File Structure: Complete" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Configuration: Loadable" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Ready for deployment! ðŸš€" >> $GITHUB_STEP_SUMMARY
